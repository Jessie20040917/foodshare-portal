<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Management - FoodShare</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

    <nav class="main-nav">
        <div class="nav-container">
            <h1 class="logo"><i class="fa-solid fa-utensils"></i> FoodShare</h1>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="recipes.html" class="active">Recipes</a>
                <a href="upload.html">Upload</a>
                <a href="media-list.html">Gallery</a>
                <a href="ai-tools.html">AI Tools</a>
            </div>
        </div>
    </nav>

    <div class="container section-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2><i class="fa-solid fa-book-open"></i> Recipe Manager</h2>
            <button class="btn btn-primary" onclick="openCreateModal()">
                <i class="fa-solid fa-plus"></i> New Recipe
            </button>
        </div>

        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search by Title or Author ID..." style="flex: 1;">
            <button class="btn btn-primary" onclick="filterRecipes()">Search</button>
            <button class="btn btn-secondary" onclick="resetSearch()">Reset</button>
        </div>

        <div id="messageBox" class="message"></div>

        <div class="card-box table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Ingredients</th>
                        <th>Tags</th>
                        <th>Author</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recipeList">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="recipeModal" class="modal">
        <div class="modal-content card-box" style="margin-bottom: 0; max-width: 600px;">
            <h3 id="modalTitle" style="border-bottom: 1px solid #eee; padding-bottom: 1rem; margin-bottom: 1.5rem;">New Recipe</h3>
            <form id="recipeForm" onsubmit="handleFormSubmit(event)">
                <input type="hidden" id="recipeId">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="title" required placeholder="e.g. Grandma's Apple Pie">
                </div>
                <div class="form-group">
                    <label>Ingredients</label>
                    <textarea id="ingredients" rows="3" required placeholder="List ingredients separated by commas"></textarea>
                </div>
                <div class="form-group">
                    <label>Tags</label>
                    <input type="text" id="tags" placeholder="e.g. dessert, sweet, vegan">
                </div>
                <div class="form-group">
                    <label>Author ID</label>
                    <input type="text" id="authorId" required>
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="note" rows="2"></textarea>
                </div>
                <div style="text-align: right; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Recipe</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loading" class="loading-overlay">
        <div style="text-align: center;">
            <i class="fa-solid fa-spinner fa-spin fa-3x" style="color: var(--accent-green);"></i>
            <p style="margin-top: 1rem;">Processing...</p>
        </div>
    </div>

    <footer class="main-footer">
        <p>&copy; 2025 FoodShare Portal. Cloud Native Computing.</p>
    </footer>

    <script src="js/api-config.js"></script>
    <script src="js/http.js"></script>
    <script>
        // ... (Keep your original script logic exactly as it was, no changes needed to JS logic)
        let isEditing = false;
        let recipesData = [];

        const showLoading = (show) => document.getElementById('loading').style.display = show ? 'flex' : 'none';
        const showMessage = (text, type = 'success') => {
            const el = document.getElementById('messageBox');
            el.textContent = text;
            el.className = `message ${type}`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        };

        document.addEventListener('DOMContentLoaded', loadRecipes);

        function filterRecipes() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!query) {
                renderRecipeList(recipesData);
                return;
            }
            const filtered = recipesData.filter(item => {
                const title = (item.title || '').toLowerCase();
                const author = (item.authorId || '').toLowerCase();
                return title.includes(query) || author.includes(query);
            });
            renderRecipeList(filtered);
        }

        function resetSearch() {
            document.getElementById('searchInput').value = '';
            renderRecipeList(recipesData);
        }

        function renderRecipeList(list) {
            const tbody = document.getElementById('recipeList');
            tbody.innerHTML = '';
            
            if (!list || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem;">No recipes found.</td></tr>';
                return;
            }

            list.forEach(item => {
                const tr = document.createElement('tr');
                let ingredientsStr = item.ingredients;
                if (typeof ingredientsStr === 'string' && ingredientsStr.trim().startsWith('[')) {
                    try {
                        const parsed = JSON.parse(ingredientsStr);
                        if (Array.isArray(parsed)) ingredientsStr = parsed.join(', ');
                    } catch (e) { }
                } else if (Array.isArray(item.ingredients)) {
                    ingredientsStr = item.ingredients.join(', ');
                }
                
                // Format Date nicely
                const dateStr = item.createdAt ? new Date(item.createdAt).toLocaleDateString() : '-';

                tr.innerHTML = `
                    <td style="font-weight:600; color:var(--accent-green);">${item.title || 'Untitled'}</td>
                    <td><small>${ingredientsStr || ''}</small></td>
                    <td><span style="background:#f0f0f0; padding:2px 6px; border-radius:4px; font-size:0.8rem;">${item.tags || '-'}</span></td>
                    <td>${item.authorId || ''}</td>
                    <td>${dateStr}</td>
                    <td>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;" onclick="openEditModal('${item.id}')"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn btn-danger" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;" onclick="deleteRecipe('${item.id}')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadRecipes() {
            showLoading(true);
            try {
                const res = await window.getJson(window.API_CONFIG.RAA_RECIPE_URL);
                const list = Array.isArray(res) ? res : (res.value || res.items || []);
                recipesData = list;
                renderRecipeList(recipesData);
            } catch (err) {
                console.error(err);
                showMessage('Failed to load recipes: ' + err.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function openCreateModal() {
            isEditing = false;
            document.getElementById('modalTitle').textContent = 'New Recipe';
            document.getElementById('recipeForm').reset();
            document.getElementById('recipeId').value = '';
            document.getElementById('recipeModal').classList.add('active');
        }

        function openEditModal(id) {
            const item = recipesData.find(r => r.id === id);
            if (!item) return;
            isEditing = true;
            document.getElementById('modalTitle').textContent = 'Edit Recipe';
            document.getElementById('recipeId').value = item.id;
            document.getElementById('title').value = item.title || '';
            document.getElementById('ingredients').value = item.ingredients || '';
            document.getElementById('tags').value = item.tags || '';
            document.getElementById('authorId').value = item.authorId || '';
            document.getElementById('note').value = item.note || '';
            document.getElementById('recipeModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('recipeModal').classList.remove('active');
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('recipeId').value;
            const title = document.getElementById('title').value;
            const ingredientsRaw = document.getElementById('ingredients').value;
            const tagsRaw = document.getElementById('tags').value;
            const authorId = document.getElementById('authorId').value;
            const note = document.getElementById('note').value;

            const tags = tagsRaw.split(',').map(t => t.trim()).filter(t => t.length > 0);
            const ingredients = ingredientsRaw.split(/\n|,/).map(i => i.trim()).filter(i => i.length > 0);

            const data = { title, ingredients, tags, authorId, note, mediaIds: [] };
            
            showLoading(true);
            try {
                if (isEditing) {
                    await window.putJson(window.API_CONFIG.UIA_RECIPE_URL, { id, ...data });
                    showMessage('Recipe updated successfully!');
                } else {
                    await window.postJson(window.API_CONFIG.CIA_RECIPE_URL, data);
                    showMessage('Recipe created successfully!');
                }
                closeModal();
                loadRecipes();
            } catch (err) {
                showMessage('Operation failed: ' + err.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteRecipe(id) {
            if (!confirm('Are you sure you want to delete this recipe?')) return;
            showLoading(true);
            try {
                let url = window.API_CONFIG.DIA_RECIPE_URL;
                if (url.includes('{id}') || url.includes('%7Bid%7D')) {
                    url = url.replace('{id}', encodeURIComponent(id)).replace('%7Bid%7D', encodeURIComponent(id));
                } else {
                    const separatorIndex = url.indexOf('?');
                    if (separatorIndex !== -1) {
                        const baseUrl = url.substring(0, separatorIndex);
                        const query = url.substring(separatorIndex);
                        const cleanBase = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;
                        url = `${cleanBase}/${encodeURIComponent(id)}${query}`;
                    } else {
                        const cleanBase = url.endsWith('/') ? url.slice(0, -1) : url;
                        url = `${cleanBase}/${encodeURIComponent(id)}`;
                    }
                }
                await window.deleteJson(url, null);
                showMessage('Recipe deleted successfully!');
                loadRecipes();
            } catch (err) {
                showMessage('Delete failed: ' + err.message, 'error');
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>